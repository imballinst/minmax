<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="favicon.ico" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0,viewport-fit=cover"
    />
    <meta name="title" content="MinMax Discount" />
    <meta
      name="description"
      content="Optimize the discount that you can get. Buy more to pay less!"
    />
    <meta name="keywords" content="discount, price" />
    <meta name="robots" content="all" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="language" content="English" />
    <meta name="author" content="imballinst" />
    <link rel="apple-touch-icon" href="apple-touch-icon.png" />

    <!-- Google / Search Engine Tags -->
    <meta itemprop="name" content="MinMax Discount" />
    <meta
      itemprop="description"
      content="Optimize the discount that you can get. Buy more to pay less!"
    />
    <meta itemprop="image" content="./logo-transparent.png" />

    <!-- Facebook Meta Tags -->
    <meta property="og:url" content="https://password.apayak.xyz" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="MinMax Discount" />
    <meta
      property="og:description"
      content="Optimize the discount that you can get. Buy more to pay less!"
    />
    <meta property="og:image" content="./logo-transparent.png" />

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="MinMax Discount" />
    <meta
      name="twitter:description"
      content="Optimize the discount that you can get. Buy more to pay less!"
    />
    <meta name="twitter:image" content="./logo-transparent.png" />

    <!-- Fonts. -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bitter:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- Styles. -->
    <link rel="stylesheet" href="./css/tailwind.css" />

    <style>
      html,
      body {
        font-family: 'Bitter', serif;
      }

      table > tbody > tr > td {
        font-family: 'Courier New', Courier, monospace;
      }
    </style>

    <title>MinMax Discount</title>
  </head>
  <body class="sm:pt-4 md:pt-8 min-h-screen flex flex-col">
    <div class="flex flex-col items-center flex-grow">
      <header class="sm:w-full md:w-1/2 lg:w-1/2 text-center mb-8">
        <h1 class="font-bold text-4xl">MinMax Discount</h1>
        <p class="font-medium">
          Dapatkan kisaran harga dengan efisiensi diskon paling tinggi
        </p>
      </header>

      <form id="minmax-form">
        <div class="shadow sm:rounded-md sm:overflow-hidden">
          <div class="px-4 py-5 bg-white space-y-6 sm:p-6">
            <fieldset>
              <label
                for="minimum-expense"
                class="block text-sm font-medium text-gray-700"
              >
                Minimal pembelian
              </label>
              <div class="mt-1 flex rounded-md shadow-sm">
                <span
                  class="
                    inline-flex
                    items-center
                    px-3
                    rounded-l-md
                    border border-r-0 border-gray-300
                    bg-gray-50
                    text-gray-500 text-sm
                  "
                >
                  Rp.
                </span>
                <input
                  type="text"
                  id="minimum-expense"
                  name="minimum-expense"
                  id="minimum-expense"
                  class="
                    focus:ring-teal-500 focus:border-teal-500
                    flex-1
                    rounded-none rounded-r-md
                    sm:text-sm
                    border-gray-300
                  "
                  placeholder="40000"
                  autocomplete="off"
                  autofocus
                />
              </div>
              <p
                class="mt-2 text-sm text-gray-500 invisible h-4"
                id="minimum-expense-helper-text"
              ></p>
            </fieldset>

            <fieldset>
              <label
                for="discount-percentage"
                class="block text-sm font-medium text-gray-700"
              >
                Persentase diskon
              </label>
              <div class="mt-1 flex rounded-md shadow-sm w-16">
                <input
                  type="text"
                  id="discount-percentage"
                  name="discount-percentage"
                  id="discount-percentage"
                  class="
                    focus:ring-teal-500 focus:border-teal-500
                    flex-1
                    w-full
                    rounded-md
                    border border-gray-300
                    sm:text-sm
                    border-gray-300
                    text-right
                  "
                  maxlength="3"
                  placeholder="30"
                  autocomplete="off"
                />
              </div>
              <p
                class="mt-2 text-sm text-gray-500 invisible h-4"
                id="discount-percentage-helper-text"
              ></p>
            </fieldset>

            <fieldset>
              <label
                for="maximum-discount"
                class="block text-sm font-medium text-gray-700"
              >
                Maksimal diskon
              </label>
              <div class="mt-1 flex rounded-md shadow-sm">
                <span
                  class="
                    inline-flex
                    items-center
                    px-3
                    rounded-l-md
                    border border-r-0 border-gray-300
                    bg-gray-50
                    text-gray-500 text-sm
                  "
                >
                  Rp.
                </span>
                <input
                  type="text"
                  id="maximum-discount"
                  name="maximum-discount"
                  id="maximum-discount"
                  class="
                    focus:ring-teal-500 focus:border-teal-500
                    flex-1
                    rounded-none rounded-r-md
                    sm:text-sm
                    border-gray-300
                  "
                  placeholder="25000"
                  autocomplete="off"
                />
              </div>
              <p
                class="mt-2 text-sm text-gray-500 invisible h-4"
                id="maximum-discount-helper-text"
              ></p>
            </fieldset>

            <button
              type="submit"
              class="
                inline-flex
                justify-center
                w-full
                py-2
                px-4
                border border-transparent
                shadow-sm
                rounded-md
                text-white
                font-bold
                bg-teal-500
                hover:bg-teal-600
                focus:outline-none
                focus:ring-2
                focus:ring-offset-2
                focus:ring-teal-500
              "
            >
              Hitung
            </button>
          </div>
        </div>
      </form>

      <div
        id="result"
        class="space-y-6 mt-8 sm:w-full md:w-1/2 lg:w-1/3 hidden"
        role="region"
        aria-live="polite"
      >
        <h2 class="font-bold text-2xl mb-4 text-center" id="result-title"></h2>

        <div id="result-optimal" class="flex flex-col">
          <p class="text-center">
            Pengeluaran dengan kisaran
            <span class="font-medium" id="result-optimal-start"></span> hingga
            <span class="font-medium" id="result-optimal-end"></span>.
          </p>

          <table class="divide-y divide-gray-200 mt-4 text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="text-right">Harga Awal (Rp)</th>
                <th class="text-right">Diskon (Rp)</th>
                <th class="text-right">Harga Akhir (Rp)</th>
              </tr>
            </thead>
            <tbody
              id="result-optimal-table-body"
              class="divide-y divide-gray-200"
            ></tbody>
          </table>
        </div>

        <p id="result-suboptimal" class="text-center">
          Diskon yang ditawarkan kurang optimal, karena seharusnya diskon
          sebesar
          <span class="font-medium" id="result-suboptimal-value"></span> bisa
          didapatkan dengan minimum pembelian
          <span class="font-medium" id="result-suboptimal-expense"></span>.
        </p>
      </div>
    </div>

    <footer
      class="flex flex-col text-gray-500 p-2 mt-8 items-center justify-center"
    >
      <p>Copyright &copy; 2021 Try Ajitiono</p>
      <p>
        <a
          href="https://github.com/imballinst/minmax"
          target="_blank"
          rel="noopener"
          class="underline hover:underline"
          >minmax on GitHub</a
        >
      </p>
    </footer>
  </body>

  <script>
    const INPUTS_AND_HELPER_TEXT_STUFF = [
      { id: 'minimum-expense' },
      {
        id: 'discount-percentage',
        additionalChecks: (number) =>
          number > 100 || number < 0 ? 'Input tidak valid.' : undefined
      },
      { id: 'maximum-discount' }
    ];
    const INPUT_AND_HELPER_TEXT_ELEMENTS = {
      'minimum-expense': document.getElementById('minimum-expense'),
      'minimum-expense-helper-text': document.getElementById(
        'minimum-expense-helper-text'
      ),
      'discount-percentage': document.getElementById('discount-percentage'),
      'discount-percentage-helper-text': document.getElementById(
        'discount-percentage-helper-text'
      ),
      'maximum-discount': document.getElementById('maximum-discount'),
      'maximum-discount-helper-text': document.getElementById(
        'maximum-discount-helper-text'
      )
    };

    // Clear validation on form change.
    const inputIds = Object.keys(INPUT_AND_HELPER_TEXT_ELEMENTS).filter(
      (id) => !id.includes('-helper-text')
    );
    inputIds.forEach((inputId) => {
      const input = INPUT_AND_HELPER_TEXT_ELEMENTS[inputId];
      const helperText =
        INPUT_AND_HELPER_TEXT_ELEMENTS[`${inputId}-helper-text`];

      input.addEventListener('keyup', () => {
        // Clear all error stuff.
        input.classList.remove('border-red-500');
        helperText.classList.add('invisible');
        helperText.classList.remove('text-red-500');
        helperText.innerHTML = '';
      });
    });

    // Form submit.
    const form = document.getElementById('minmax-form');

    // For showing results.
    const resultDiv = document.getElementById('result');
    const resultTitleHeading = document.getElementById('result-title');

    const resultOptimalDiv = document.getElementById('result-optimal');
    const resultRangeStartDiv = document.getElementById('result-optimal-start');
    const resultRangeEndDiv = document.getElementById('result-optimal-end');
    const resultTableBody = document.getElementById(
      'result-optimal-table-body'
    );

    const resultSuboptimalDiv = document.getElementById('result-suboptimal');
    const resultSuboptimalValueDiv = document.getElementById(
      'result-suboptimal-value'
    );
    const resultSuboptimalExpenseDiv = document.getElementById(
      'result-suboptimal-expense'
    );

    form.addEventListener('submit', (e) => {
      e.preventDefault();

      const formData = new FormData(form);

      // Validate.
      const values = {};
      const errors = {};

      INPUTS_AND_HELPER_TEXT_STUFF.forEach(({ id, additionalChecks }) => {
        const value = formData.get(id);
        const error = validateEmptinessAndNumbers(value, additionalChecks);

        if (error === undefined) {
          values[id] = Number(value);
        } else {
          errors[id] = error;
        }
      });

      if (Object.keys(errors).length > 0) {
        for (const key in errors) {
          INPUT_AND_HELPER_TEXT_ELEMENTS[key].classList.add('border-red-500');
          INPUT_AND_HELPER_TEXT_ELEMENTS[`${key}-helper-text`].classList.remove(
            'invisible'
          );
          INPUT_AND_HELPER_TEXT_ELEMENTS[`${key}-helper-text`].classList.add(
            'text-red-500'
          );
          INPUT_AND_HELPER_TEXT_ELEMENTS[`${key}-helper-text`].innerHTML =
            errors[key];
        }

        return;
      }

      const minimumExpense = values['minimum-expense'];
      const percentage = values['discount-percentage'];
      const maximumDiscountValue = values['maximum-discount'];

      const discountValueWithMinimumExpense = getDiscount(
        minimumExpense,
        percentage
      );

      // Suboptimal discount check.
      if (discountValueWithMinimumExpense > maximumDiscountValue) {
        // This is suboptimal, because even with minimum expense,
        // we already surpass the maximum discount value.
        resultSuboptimalDiv.classList.remove('hidden');
        resultOptimalDiv.classList.add('hidden');

        // Modify DOM.
        resultSuboptimalValueDiv.innerHTML = discountValueWithMinimumExpense;
        resultSuboptimalExpenseDiv.innerHTML = minimumExpense;
        resultTitleHeading.innerHTML = 'Diskon Kurang Optimal';
      } else {
        // Maximum discount.
        const optimalExpense = Math.floor(
          (maximumDiscountValue * 100) / percentage
        );

        // Add ranges for in-betweens.
        const rows = [];
        let iteratedExpense = minimumExpense;

        while (iteratedExpense <= optimalExpense) {
          const discountValue = getDiscount(iteratedExpense, percentage);
          const netValue = Math.floor(iteratedExpense - discountValue);

          rows.push([iteratedExpense, discountValue, netValue]);

          if (
            iteratedExpense + 10000 > optimalExpense &&
            iteratedExpense !== optimalExpense
          ) {
            // Override on maximum.
            iteratedExpense = optimalExpense;
          } else {
            iteratedExpense += 10000;
          }
        }

        // Modify DOM.
        resultOptimalDiv.classList.remove('hidden');
        resultSuboptimalDiv.classList.add('hidden');

        resultDiv.classList.remove('hidden');
        resultRangeStartDiv.innerHTML = `Rp.${minimumExpense}`;
        resultRangeEndDiv.innerHTML = `Rp.${optimalExpense}`;
        resultTitleHeading.innerHTML = 'Diskon Optimal';

        const newTableBody = document.createElement('tbody');

        for (const row of rows) {
          const newTableRow = document.createElement('tr');

          for (const col of row) {
            const newTableCol = document.createElement('td');
            newTableCol.innerHTML = addNumberSeparator(col);
            newTableCol.classList.add('text-right');

            newTableRow.appendChild(newTableCol);
          }

          newTableBody.appendChild(newTableRow);
        }
        resultTableBody.innerHTML = newTableBody.innerHTML;
      }

      resultDiv.classList.remove('hidden');
    });

    // Helper functions.
    function getDiscount(price, percentage) {
      return Math.floor((price * percentage) / 100);
    }

    function validateEmptinessAndNumbers(stringInput, additionalChecks) {
      const number = Number(stringInput);
      const isEmpty = stringInput === '';
      const isInvalid = isNaN(number) || number <= 0;

      if (isInvalid || isEmpty) {
        return isEmpty ? 'Input tidak boleh kosong.' : 'Input tidak valid.';
      }

      if (typeof additionalChecks === 'function') {
        return additionalChecks(number);
      }

      return undefined;
    }

    function addNumberSeparator(str) {
      const characters = str.toString().split('').reverse();
      const length = characters.length;
      let result = '';

      for (let i = 0; i < length; i++) {
        if (i > 0 && i % 3 === 0) {
          result = `.${result}`;
        }

        result = `${characters[i]}${result}`;
      }

      return result;
    }
  </script>

  <!-- [remove-on-prod:start] -->
  <script src="./dev/socket.io.js"></script>

  <script>
    const socket = io('http://localhost:3000');
    socket.on('reload', (e) => {
      window.location.reload();
    });
  </script>
  <!-- [remove-on-prod:finish] -->
</html>
